<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>质押分红 DApp - 排查版</title>
    <style>
        body { font-family: Arial; max-width: 600px; margin: 20px auto; padding: 0 20px; }
        .btn { background: #0066ff; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .btn:disabled { background: #666; cursor: not-allowed; }
        .status { margin-top: 15px; padding: 10px; border-radius: 5px; display: none; }
        .success { background: #d4edda; color: #155724; display: block; }
        .error { background: #f8d7da; color: #721c24; display: block; }
        .info { background: #d1ecf1; color: #0c5460; display: block; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>质押分红 DApp（排查版）</h1>
    <button id="connect-btn" class="btn">连接 MetaMask</button>
    <div id="status" class="status"></div>
    <div id="content" class="hidden" style="margin-top: 20px;">
        <p>已连接账户: <span id="account">-</span></p>
        <p>当前网络: <span id="network">-</span></p>
    </div>

    <script>
        // 核心配置（必须核对！）
        const CONTRACT_ADDRESS = '0xCb5c82879A56006d6eEF2d03391E48ff774919A2';
        const BSC_MAINNET_CHAIN_ID = '0x38'; // 56的十六进制
        const LOG_PREFIX = '[DApp日志]:';

        // 第一步：页面加载日志（确认JS开始执行）
        console.log(LOG_PREFIX, '页面开始加载，JS执行启动');

        //  DOM元素获取（尽早获取，避免DOM未加载）
        const connectBtn = document.getElementById('connect-btn');
        const statusEl = document.getElementById('status');
        const contentEl = document.getElementById('content');
        const accountEl = document.getElementById('account');
        const networkEl = document.getElementById('network');

        // 第二步：输出DOM获取结果（确认是否拿到按钮）
        console.log(LOG_PREFIX, 'DOM元素获取结果：');
        console.log(LOG_PREFIX, 'connectBtn存在？', !!connectBtn);
        console.log(LOG_PREFIX, 'statusEl存在？', !!statusEl);

        // 第三步：绑定点击事件（用最原始的方式，确保绑定成功）
        if (connectBtn) {
            connectBtn.addEventListener('click', async function() {
                console.log(LOG_PREFIX, '按钮被点击！开始执行连接逻辑');
                await connectWallet();
            });
            console.log(LOG_PREFIX, '点击事件绑定成功');
        } else {
            console.error(LOG_PREFIX, 'ERROR: 未找到连接按钮，事件绑定失败');
            statusEl.textContent = '错误：页面元素加载失败，请刷新页面';
            statusEl.className = 'status error';
        }

        // 核心连接逻辑（每步都加日志）
        async function connectWallet() {
            try {
                // 禁用按钮，避免重复点击
                connectBtn.disabled = true;
                connectBtn.textContent = '连接中...';
                statusEl.textContent = '正在连接MetaMask...';
                statusEl.className = 'status info';
                console.log(LOG_PREFIX, '禁用按钮，开始检测MetaMask');

                // 第四步：检测MetaMask
                if (!window.ethereum) {
                    throw new Error('未检测到MetaMask，请安装后重试');
                }
                console.log(LOG_PREFIX, '检测到MetaMask，window.ethereum存在');

                // 第五步：请求授权
                console.log(LOG_PREFIX, '发起账户授权请求');
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                console.log(LOG_PREFIX, '授权请求返回结果:', accounts);

                if (!accounts || accounts.length === 0) {
                    throw new Error('用户拒绝了授权');
                }
                const account = accounts[0];
                console.log(LOG_PREFIX, '获取到账户:', account);

                // 第六步：获取当前网络
                console.log(LOG_PREFIX, '发起网络查询请求');
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                console.log(LOG_PREFIX, '当前网络chainId:', chainId);

                // 第七步：验证网络
                const isBSC = chainId === BSC_MAINNET_CHAIN_ID;
                console.log(LOG_PREFIX, '是否为BSC主网？', isBSC);

                // 第八步：更新UI
                accountEl.textContent = account.substring(0,6) + '...' + account.substring(38);
                networkEl.textContent = isBSC ? 'BSC主网（56）' : `未知网络（${chainId}）`;
                contentEl.classList.remove('hidden');
                statusEl.textContent = isBSC ? '连接成功！' : '连接成功，但网络不是BSC主网，请切换';
                statusEl.className = 'status success';
                console.log(LOG_PREFIX, 'UI更新完成，连接流程结束');

            } catch (error) {
                // 错误日志（输出完整错误信息）
                console.error(LOG_PREFIX, '连接失败，错误详情:', error);
                statusEl.textContent = `连接失败: ${error.message}`;
                statusEl.className = 'status error';
            } finally {
                // 恢复按钮状态
                connectBtn.disabled = false;
                connectBtn.textContent = '连接 MetaMask';
                console.log(LOG_PREFIX, '恢复按钮状态，流程结束');
            }
        }

        // 额外：监听网络变化（日志）
        if (window.ethereum) {
            window.ethereum.on('chainChanged', (chainId) => {
                console.log(LOG_PREFIX, '网络切换事件触发，新chainId:', chainId);
                networkEl.textContent = chainId === BSC_MAINNET_CHAIN_ID ? 'BSC主网（56）' : `未知网络（${chainId}）`;
            });
            console.log(LOG_PREFIX, '网络变化监听绑定成功');
        }

        // 最后：输出初始化完成日志
        console.log(LOG_PREFIX, 'JS初始化完成，等待用户点击');
    </script>
</body>
</html>

