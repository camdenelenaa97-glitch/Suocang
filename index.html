<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSCé”ä»“è§£é”å·¥å…·ï¼ˆä¼˜åŒ–ç‰ˆï¼‰</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 128 128%22><text x=%220%22 y=%2290%22 font-size=%2290%22>ğŸ”“</text></svg>" type="image/svg+xml">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #1a1a2e;
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #ffffff;
        }

        .connect-btn {
            background-color: #0066ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .connect-btn:disabled {
            background-color: #666;
            cursor: not-allowed;
        }

        .connect-btn:hover:not(:disabled) {
            background-color: #0052cc;
        }

        .section {
            background-color: #16213e;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #e0e0e0;
        }

        .info-line {
            margin-bottom: 10px;
            color: #b0b0b0;
        }

        .stake-item {
            background-color: #0f360;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .stake-item .stake-info {
            font-size: 14px;
            margin-bottom: 5px;
            color: #b0b0b0;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            font-size: 16px;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #e74c3c;
            color: white;
        }

        .btn-primary:hover {
            background-color: #c0392b;
        }

        .btn-outline {
            background-color: transparent;
            color: #b0b0b0;
            border: 1px solid #333;
        }

        .btn-outline:hover {
            background-color: #2d3436;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #b0b0b0;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            background-color: #0f360;
            border: 1px solid #333;
            border-radius: 5px;
            color: white;
            font-size: 16px;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }

        .status.success {
            background-color: #27ae60;
            color: white;
            display: block;
        }

        .status.error {
            background-color: #c0392b;
            color: white;
            display: block;
        }

        .status.info {
            background-color: #3498db;
            color: white;
            display: block;
        }

        .hidden {
            display: none;
        }

        .warning {
            background-color: #e67e22;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            font-size: 14px;
        }

        .note {
            font-size: 13px;
            color: #888;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">ğŸ”“ BSCé”ä»“è§£é”å·¥å…·ï¼ˆä¼˜åŒ–ç‰ˆï¼‰</div>
            <button id="connect-btn" class="connect-btn">è¿æ¥é’±åŒ…</button>
        </header>

        <div id="app-content" class="hidden">
            <!-- è´¦æˆ·ä¿¡æ¯ -->
            <div class="section">
                <div class="section-title">è´¦æˆ·ä¿¡æ¯</div>
                <div class="info-line">å·²è¿æ¥è´¦æˆ·: <span id="connected-account">-</span></div>
                <div class="info-line">å½“å‰ç½‘ç»œ: <span id="current-network">-</span></div>
                <div class="info-line">é”ä»“è®°å½•æ€»æ•°: <span id="stake-count">-</span></div>
                <div class="warning hidden" id="network-warning">
                    âš ï¸ è­¦å‘Šï¼šå½“å‰ç½‘ç»œä¸æ˜¯ BSC ä¸»ç½‘ï¼Œè¯·åˆ‡æ¢åˆ° BSC ä¸»ç½‘ï¼ˆChain ID: 56ï¼‰åé‡è¯•ï¼
                </div>
            </div>

            <!-- é”ä»“è®°å½• -->
            <div class="section">
                <div class="section-title">æˆ‘çš„é”ä»“è®°å½•</div>
                <button id="refresh-stakes" class="btn btn-outline">åˆ·æ–°é”ä»“è®°å½•</button>
                <div id="stakes-list" style="margin-top: 15px;">
                    <div style="text-align: center; color: #666;">æš‚æ— é”ä»“è®°å½•</div>
                </div>
                <div class="note">æç¤ºï¼šæ¯ä¸ªé”ä»“è®°å½•å¯¹åº”ä¸€ä¸ªç´¢å¼•ï¼Œè§£é”æ—¶éœ€è¦è¾“å…¥å¯¹åº”çš„ç´¢å¼•</div>
                <div class="note">æç¤ºï¼šå¦‚æœæœ‰3ç¬”é”ä»“ï¼Œéœ€è¦åˆ†3æ¬¡è§£é”ï¼Œä¾æ¬¡è¾“å…¥0ã€1ã€2</div>
            </div>

            <!-- è§£é”æ“ä½œ -->
            <div class="section">
                <div class="section-title">è§£é”æ“ä½œ</div>
                <div class="input-group">
                    <label for="unstake-index">è¾“å…¥è¦è§£é”çš„ç´¢å¼•ï¼ˆä»0å¼€å§‹ï¼‰</label>
                    <input type="number" id="unstake-index" placeholder="ä¾‹å¦‚ï¼š0ï¼ˆç¬¬ä¸€ä¸ªé”ä»“è®°å½•ï¼‰" min="0">
                </div>
                <button id="unstake-btn" class="btn btn-primary">ğŸ”“ ç«‹å³è§£é”</button>
                <div class="note">æç¤ºï¼šè§£é”åï¼Œå¯¹åº”çš„é”ä»“è®°å½•ä¼šä»åˆ—è¡¨ä¸­ç§»é™¤</div>
                <div class="note">æç¤ºï¼šå¦‚æœè§£é”å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç´¢å¼•æ— æ•ˆã€æœªåˆ°è§£é”æ—¶é—´æˆ–gasä¸è¶³</div>
            </div>

            <!-- çŠ¶æ€æç¤º -->
            <div id="status" class="status"></div>
        </div>

        <!-- æœªè¿æ¥é’±åŒ…æ—¶çš„æ¬¢è¿é¡µ -->
        <div id="welcome-content">
            <div class="section" style="text-align: center; padding: 50px 20px;">
                <div class="section-title" style="font-size: 24px; margin-bottom: 20px;">æ¬¢è¿ä½¿ç”¨ BSC é”ä»“è§£é”å·¥å…·</div>
                <p style="margin-bottom: 30px; color: #b0b0b0; line-height: 1.6;">
                    è¯·è¿æ¥æ‚¨çš„ MetaMask é’±åŒ…<br>
                    å¹¶åˆ‡æ¢è‡³ <strong>BSC ä¸»ç½‘ï¼ˆChain ID: 56ï¼‰</strong> å¼€å§‹ä½¿ç”¨
                </p>
                <button id="welcome-connect-btn" class="connect-btn">è¿æ¥é’±åŒ…</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== æ ¸å¿ƒé…ç½® ====================
        const CONTRACT_ADDRESS = '0xCb5c82879A56006d6eEF2d03391E48ff774919A2';
        const BSC_MAINNET_CHAIN_ID = '0x38'; // 56çš„åå…­è¿›åˆ¶
        const BSC_TESTNET_CHAIN_ID = '0x61'; // 97çš„åå…­è¿›åˆ¶
        let currentAccount = null;
        let currentChainId = null;
        let stakeCount = 0; // é”ä»“è®°å½•æ€»æ•°

        // ==================== å·¥å…·å‡½æ•° ====================
        // ç”Ÿæˆå‡½æ•°ç­¾åå“ˆå¸Œï¼ˆå…³é”®ï¼šä½¿ç”¨BscScanä¸Šå®é™…æ˜¾ç¤ºçš„å‡½æ•°ç­¾åï¼‰
        async function getFunctionSignatureHash(functionName, params) {
            const funcStr = `${functionName}(${params.join(',')})`;
            const encoder = new TextEncoder();
            const hash = await crypto.subtle.digest('SHA-256', encoder.encode(funcStr));
            return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 8);
        }

        // ç¼–ç åœ°å€å‚æ•°
        function encodeAddress(address) {
            return address.replace('0x', '').padStart(64, '0');
        }

        // ç¼–ç uint256å‚æ•°
        function encodeUint256(value) {
            return BigInt(value).toString(16).padStart(64, '0');
        }

        // ç¼–ç å‡½æ•°è°ƒç”¨æ•°æ®
        async function encodeFunctionCall(functionName, params, paramTypes) {
            const sigHash = await getFunctionSignatureHash(functionName, paramTypes);
            let data = '';
            
            for (let i = 0; i < params.length; i++) {
                const param = params[i];
                const type = paramTypes[i];
                
                if (type === 'address') {
                    data += encodeAddress
