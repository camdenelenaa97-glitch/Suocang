<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSC锁代币质押页面</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h2 {
            margin-top: 0;
            color: #555;
            font-size: 18px;
        }
        input, button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .success {
            background-color: #dff2bf;
            color: #4F8A10;
        }
        .error {
            background-color: #ffbaba;
            color: #D8000C;
        }
        .info {
            background-color: #bde5f8;
            color: #00529B;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>BSC锁代币质押页面</h1>
        
        <div class="section">
            <h2>钱包连接（需切换BSC网络）</h2>
            <button id="connectBtn">连接钱包</button>
            <div id="walletAddress" class="info" style="display: none;"></div>
            <div id="networkTip" class="info" style="display: none;">✅ 当前网络：BSC（Binance Smart Chain）</div>
        </div>
        
        <div class="section">
            <h2>账户信息</h2>
            <div id="tokenBalance" class="info" style="display: none;">锁代币余额: <span id="balanceValue">0</span></div>
            <div id="stakedAmount" class="info" style="display: none;">已质押数量: <span id="stakedValue">0</span></div>
        </div>
        
        <div class="section">
            <h2>授权操作</h2>
            <input type="number" id="approveAmount" placeholder="输入要授权的锁代币数量" min="0" step="0.000000000000000001">
            <button id="approveBtn" disabled>授权</button>
            <div id="approveStatus" class="status" style="display: none;"></div>
        </div>
        
        <div class="section">
            <h2>质押操作</h2>
            <input type="number" id="stakeAmount" placeholder="输入要质押的锁代币数量" min="0" step="0.000000000000000001">
            <button id="stakeBtn" disabled>质押</button>
            <div id="stakeStatus" class="status" style="display: none;"></div>
        </div>
        
        <div class="section">
            <h2>取消质押操作</h2>
            <input type="number" id="unstakeAmount" placeholder="输入要取消质押的锁代币数量" min="0" step="0.000000000000000001">
            <button id="unstakeBtn" disabled>取消质押</button>
            <div id="unstakeStatus" class="status" style="display: none;"></div>
        </div>
    </div>

    <!-- BSC适配版 ethers.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
    <script>
        // BSC链核心配置
        const BSC_CHAIN_ID = "0x38"; // BSC主网链ID
        const TOKEN_CONTRACT_ADDRESS = "0x574f567a3f76b555d0a60bacb1110bf79d2c7777";
        const STAKE_CONTRACT_ADDRESS = "0xCb5c82879A56006d6eEF2d03391E48ff774919A2";
        
        // 合约ABI（BSC链适配，确保函数签名匹配）
        const TOKEN_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)"
        ];
        
        const STAKE_ABI = [
            "function stake(uint256 amount) external returns (bool)",
            "function unstake(uint256 amount) external returns (bool)",
            "function userStakes(address user) external view returns (uint256)"
        ];
        
        // 全局变量
        let provider, signer, address;
        let tokenContract, stakeContract;
        
        // DOM元素
        const connectBtn = document.getElementById("connectBtn");
        const walletAddress = document.getElementById("walletAddress");
        const networkTip = document.getElementById("networkTip");
        const tokenBalance = document.getElementById("tokenBalance");
        const balanceValue = document.getElementById("balanceValue");
        const stakedAmount = document.getElementById("stakedAmount");
        const stakedValue = document.getElementById("stakedValue");
        const approveAmount = document.getElementById("approveAmount");
        const approveBtn = document.getElementById("approveBtn");
        const approveStatus = document.getElementById("approveStatus");
        const stakeAmount = document.getElementById("stakeAmount");
        const stakeBtn = document.getElementById("stakeBtn");
        const stakeStatus = document.getElementById("stakeStatus");
        const unstakeAmount = document.getElementById("unstakeAmount");
        const unstakeBtn = document.getElementById("unstakeBtn");
        const unstakeStatus = document.getElementById("unstakeStatus");
        
        // 检查并切换BSC网络
        async function checkAndSwitchNetwork() {
            try {
                const currentChainId = await provider.getNetwork().then(net => net.chainId.toString(16));
                if (currentChainId !== BSC_CHAIN_ID) {
                    // 切换到BSC主网
                    await window.ethereum.request({
                        method: "wallet_switchEthereumChain",
                        params: [{ chainId: BSC_CHAIN_ID }]
                    });
                }
                networkTip.style.display = "block";
                return true;
            } catch (error) {
                // 未添加BSC网络，提示用户手动添加
                if (error.code === 4902) {
                    showStatus(approveStatus, "请先在钱包中添加BSC主网", "error");
                } else {
                    showStatus(approveStatus, "请切换到BSC主网", "error");
                }
                return false;
            }
        }
        
        // 连接钱包
        connectBtn.addEventListener("click", async () => {
            if (!window.ethereum) {
                showStatus(approveStatus, "请安装MetaMask/Trust Wallet等钱包", "error");
                return;
            }
            
            try {
                // 初始化Provider（适配BSC）
                provider = new ethers.BrowserProvider(window.ethereum);
                // 请求连接钱包
                await window.ethereum.request({ method: "eth_requestAccounts" });
                signer = await provider.getSigner();
                address = await signer.getAddress();
                
                // 检查网络
                const isBSCNetwork = await checkAndSwitchNetwork();
                if (!isBSCNetwork) return;
                
                // 显示钱包地址
                walletAddress.textContent = `已连接: ${address.slice(0, 6)}...${address.slice(-4)}`;
                walletAddress.style.display = "block";
                
                // 初始化合约（BSC链适配）
                tokenContract = new ethers.Contract(TOKEN_CONTRACT_ADDRESS, TOKEN_ABI, signer);
                stakeContract = new ethers.Contract(STAKE_CONTRACT_ADDRESS, STAKE_ABI, signer);
                
                // 更新账户信息
                await updateAccountInfo();
                
                // 启用功能按钮
                approveBtn.disabled = false;
                stakeBtn.disabled = false;
                unstakeBtn.disabled = false;
                connectBtn.disabled = true;
                connectBtn.textContent = "已连接";
            } catch (error) {
                showStatus(approveStatus, "连接失败: " + error.message, "error");
            }
        });
        
        // 更新账户信息
        async function updateAccountInfo() {
            try {
                // 获取锁代币余额（BSC链wei转换）
                const balance = await tokenContract.balanceOf(address);
                balanceValue.textContent = ethers.formatEther(balance);
                tokenBalance.style.display = "block";
                
                // 获取已质押数量
                const staked = await stakeContract.userStakes(address);
                stakedValue.textContent = ethers.formatEther(staked);
                stakedAmount.style.display = "block";
            } catch (error) {
                showStatus(approveStatus, "获取信息失败: " + error.message, "error");
            }
        }
        
        // 授权操作
        approveBtn.addEventListener("click", async () => {
            const amount = approveAmount.value;
            if (!amount || amount <= 0) {
                showStatus(approveStatus, "请输入有效数量", "error");
                return;
            }
            
            try {
                showStatus(approveStatus, "授权中...", "info");
                const amountWei = ethers.parseEther(amount);
                const tx = await tokenContract.approve(STAKE_CONTRACT_ADDRESS, amountWei);
                await tx.wait();
                showStatus(approveStatus, "授权成功！", "success");
                await updateAccountInfo();
            } catch (error) {
                showStatus(approveStatus, "授权失败: " + error.message, "error");
            }
        });
        
        // 质押操作
