<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSCé”ä»“è§£é”å·¥å…·ï¼ˆæç®€ç‰ˆï¼‰</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 128 128%22><text x=%220%22 y=%2290%22 font-size=%2290%22>ğŸ”“</text></svg>" type="image/svg+xml">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #1a1a2e;
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #ffffff;
        }

        .connect-btn {
            background-color: #0066ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .connect-btn:disabled {
            background-color: #666;
            cursor: not-allowed;
        }

        .connect-btn:hover:not(:disabled) {
            background-color: #0052cc;
        }

        .section {
            background-color: #16213e;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #e0e0e0;
        }

        .info-line {
            margin-bottom: 10px;
            color: #b0b0b0;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            font-size: 16px;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #e74c3c;
            color: white;
        }

        .btn-primary:hover {
            background-color: #c0392b;
        }

        .btn-outline {
            background-color: transparent;
            color: #b0b0b0;
            border: 1px solid #333;
        }

        .btn-outline:hover {
            background-color: #2d3436;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #b0b0b0;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            background-color: #0f360;
            border: 1px solid #333;
            border-radius: 5px;
            color: white;
            font-size: 16px;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }

        .status.success {
            background-color: #27ae60;
            color: white;
            display: block;
        }

        .status.error {
            background-color: #c0392b;
            color: white;
            display: block;
        }

        .status.info {
            background-color: #3498db;
            color: white;
            display: block;
        }

        .hidden {
            display: none;
        }

        .warning {
            background-color: #e67e22;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            font-size: 14px;
        }

        .note {
            font-size: 13px;
            color: #888;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">ğŸ”“ BSCé”ä»“è§£é”å·¥å…·ï¼ˆæç®€ç‰ˆï¼‰</div>
            <button id="connect-btn" class="connect-btn">è¿æ¥é’±åŒ…</button>
        </header>

        <div id="app-content" class="hidden">
            <!-- è´¦æˆ·ä¿¡æ¯ -->
            <div class="section">
                <div class="section-title">è´¦æˆ·ä¿¡æ¯</div>
                <div class="info-line">å·²è¿æ¥è´¦æˆ·: <span id="connected-account">-</span></div>
                <div class="info-line">å½“å‰ç½‘ç»œ: <span id="current-network">-</span></div>
                <div class="warning hidden" id="network-warning">
                    âš ï¸ è­¦å‘Šï¼šå½“å‰ç½‘ç»œä¸æ˜¯ BSC ä¸»ç½‘ï¼Œè¯·åˆ‡æ¢åˆ° BSC ä¸»ç½‘ï¼ˆChain ID: 56ï¼‰åé‡è¯•ï¼
                </div>
            </div>

            <!-- è§£é”æ“ä½œ -->
            <div class="section">
                <div class="section-title">è§£é”æ“ä½œ</div>
                <div class="input-group">
                    <label for="unstake-index">è¾“å…¥è¦è§£é”çš„ç´¢å¼•ï¼ˆä»0å¼€å§‹ï¼‰</label>
                    <input type="number" id="unstake-index" placeholder="ä¾‹å¦‚ï¼š0ï¼ˆç¬¬ä¸€ä¸ªé”ä»“è®°å½•ï¼‰" min="0">
                </div>
                <button id="unstake-btn" class="btn btn-primary">ğŸ”“ ç«‹å³è§£é”</button>
                <div class="note">æç¤ºï¼šå¦‚æœæœ‰3ç¬”é”ä»“ï¼Œéœ€è¦åˆ†3æ¬¡è§£é”ï¼Œä¾æ¬¡è¾“å…¥0ã€1ã€2</div>
                <div class="note">æç¤ºï¼šè§£é”åï¼Œå¯¹åº”çš„é”ä»“è®°å½•ä¼šä»åˆ—è¡¨ä¸­ç§»é™¤</div>
                <div class="note">æç¤ºï¼šå¦‚æœè§£é”å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç´¢å¼•æ— æ•ˆã€æœªåˆ°è§£é”æ—¶é—´æˆ–gasä¸è¶³</div>
            </div>

            <!-- çŠ¶æ€æç¤º -->
            <div id="status" class="status"></div>
        </div>

        <!-- æœªè¿æ¥é’±åŒ…æ—¶çš„æ¬¢è¿é¡µ -->
        <div id="welcome-content">
            <div class="section" style="text-align: center; padding: 50px 20px;">
                <div class="section-title" style="font-size: 24px; margin-bottom: 20px;">æ¬¢è¿ä½¿ç”¨ BSC é”ä»“è§£é”å·¥å…·</div>
                <p style="margin-bottom: 30px; color: #b0b0b0; line-height: 1.6;">
                    è¯·è¿æ¥æ‚¨çš„ MetaMask é’±åŒ…<br>
                    å¹¶åˆ‡æ¢è‡³ <strong>BSC ä¸»ç½‘ï¼ˆChain ID: 56ï¼‰</strong> å¼€å§‹ä½¿ç”¨
                </p>
                <button id="welcome-connect-btn" class="connect-btn">è¿æ¥é’±åŒ…</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== æ ¸å¿ƒé…ç½® ====================
        const CONTRACT_ADDRESS = '0xCb5c82879A56006d6eEF2d03391E48ff774919A2';
        const BSC_MAINNET_CHAIN_ID = '0x38'; // 56çš„åå…­è¿›åˆ¶
        let currentAccount = null;
        let currentChainId = null;

        // ==================== å…³é”®ä¼˜åŒ–ï¼šç›´æ¥ä½¿ç”¨BscScanä¸Šçš„å‡½æ•°ç­¾å ====================
        // 1. unstake å‡½æ•°ç­¾åï¼ˆBscScanä¸Šæ˜¾ç¤ºï¼š0x2e17de78ï¼‰
        const UNSTAKE_FUNCTION_SIGNATURE = '0x2e17de78';

        // 2. ç¼–ç uint256å‚æ•°ï¼ˆç´¢å¼•ï¼‰
        function encodeUint256(value) {
            return BigInt(value).toString(16).padStart(64, '0');
        }

        // 3. ç¼–ç è§£é”äº¤æ˜“æ•°æ®ï¼ˆç›´æ¥ä½¿ç”¨å·²çŸ¥çš„å‡½æ•°ç­¾åï¼‰
        function encodeUnstakeData(index) {
            const encodedIndex = encodeUint256(index);
            return `${UNSTAKE_FUNCTION_SIGNATURE}${encodedIndex}`;
        }

        // ==================== DOMå…ƒç´  ====================
        const domElements = {
            connectBtn: document.getElementById('connect-btn'),
            welcomeConnectBtn: document.getElementById('welcome-connect-btn'),
            appContent: document.getElementById('app-content'),
            welcomeContent: document.getElementById('welcome-content'),
            networkWarning: document.getElementById('network-warning'),
            connectedAccountEl: document.getElementById('connected-account'),
            currentNetworkEl: document.getElementById('current-network'),
            unstakeIndexInput: document.getElementById('unstake-index'),
            unstakeBtn: document.getElementById('unstake-btn'),
            statusEl: document.getElementById('status')
        };

        // ==================== äº‹ä»¶ç»‘å®š ====================
        if (domElements.connectBtn) domElements.connectBtn.addEventListener('click', connectWallet);
        if (domElements.welcomeConnectBtn) domElements.welcomeConnectBtn.addEventListener('click', connectWallet);
        if (domElements.unstakeBtn) domElements.unstakeBtn.addEventListener('click', unstake);

        // ç›‘å¬ç½‘ç»œå˜åŒ–
        if (window.ethereum) {
            window.ethereum.on('chainChanged', (chainId) => {
                currentChainId = chainId;
                checkNetwork();
                updateNetworkDisplay();
            });
        }

        // ==================== æ ¸å¿ƒé€»è¾‘ ====================
        // è¿æ¥é’±åŒ…ï¼ˆä½¿ç”¨ä¹‹å‰æˆåŠŸçš„è¿æ¥é€»è¾‘ï¼‰
        async function connectWallet() {
            const { connectBtn, welcomeConnectBtn, statusEl } = domElements;

            try {
                // ç¦ç”¨æŒ‰é’®
                if (connectBtn) { connectBtn.disabled = true; connectBtn.textContent = 'è¿æ¥ä¸­...'; }
                if (welcomeConnectBtn) { welcomeConnectBtn.disabled = true; welcomeConnectBtn.textContent = 'è¿æ¥ä¸­...'; }
                if (statusEl) { statusEl.textContent = 'æ­£åœ¨è¿æ¥MetaMask...'; statusEl.className = 'status info'; }

                // æ£€æµ‹MetaMask
                if (!window.ethereum) {
                    throw new Error('æœªæ£€æµ‹åˆ°MetaMaskï¼Œè¯·å®‰è£…åé‡è¯•');
                }

                // è¯·æ±‚æˆæƒ
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (!accounts || accounts.length === 0) throw new Error('ç”¨æˆ·æ‹’ç»äº†æˆæƒ');
                currentAccount = accounts[0];

                // è·å–ç½‘ç»œ
                currentChainId = await window.ethereum.request({ method: 'eth_chainId' });

                // æ£€æŸ¥ç½‘ç»œ
                const isSupported = checkNetwork();
                if (!isSupported) {
                    throw new Error('å½“å‰ç½‘ç»œä¸æ˜¯BSCä¸»ç½‘ï¼Œè¯·åˆ‡æ¢åˆ°BSCä¸»ç½‘ï¼ˆChain ID: 56ï¼‰');
                }

                // æ›´æ–°UI
                updateAccountDisplay();
                updateNetworkDisplay();
                if (domElements.appContent) domElements.appContent.classList.remove('hidden');
                if (domElements.welcomeContent) domElements.welcomeContent.classList.add('hidden');
                if (statusEl) { statusEl.textContent = 'è¿æ¥æˆåŠŸï¼'; statusEl.className = 'status success'; }

            } catch (error) {
                console.error('è¿æ¥å¤±è´¥:', error);
                if (statusEl) { statusEl.textContent = `è¿æ¥å¤±è´¥: ${error.message}`; statusEl.className = 'status error'; }
            } finally {
                // æ¢å¤æŒ‰é’®
                if (connectBtn) { connectBtn.disabled = false; connectBtn.textContent = 'è¿æ¥é’±åŒ…'; }
                if (welcomeConnectBtn) { welcomeConnectBtn.disabled = false; welcomeConnectBtn.textContent = 'è¿æ¥é’±åŒ…'; }
            }
        }

        // æ£€æŸ¥ç½‘ç»œ
        function checkNetwork() {
            const isSupported = currentChainId === BSC_MAINNET_CHAIN_ID;
            if (domElements.networkWarning) {
                domElements.networkWarning.classList.toggle('hidden', isSupported);
            }
            return isSupported;
        }

        // è§£é”æ“ä½œï¼ˆç›´æ¥ä½¿ç”¨BscScanä¸Šçš„å‡½æ•°ç­¾åï¼‰
        async function unstake() {
            const { unstakeIndexInput, statusEl } = domElements;
            try {
                if (!checkNetwork()) throw new Error('ç½‘ç»œä¸æ”¯æŒ');
                if (!currentAccount) throw new Error('æœªè¿æ¥è´¦æˆ·');

                const index = parseInt(unstakeIndexInput.value.trim());
                if (isNaN(index) || index < 0) throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„ç´¢å¼•ï¼ˆä»0å¼€å§‹ï¼‰');

                if (statusEl) { statusEl.textContent = 'æ­£åœ¨è§£é”...'; statusEl.className = 'status info'; }

                // ç¼–ç è§£é”äº¤æ˜“æ•°æ®ï¼ˆç›´æ¥ä½¿ç”¨å·²çŸ¥çš„å‡½æ•°ç­¾åï¼‰
                const unstakeData = encodeUnstakeData(index);

                // å‘èµ·è§£é”äº¤æ˜“
                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        to: CONTRACT_ADDRESS,
                        data: unstakeData,
                        from: currentAccount,
                        gasLimit: '0x500000' // å¢åŠ gasé™åˆ¶
                    }]
                });

                if (statusEl) { 
                    statusEl.textContent = `ğŸ”“ è§£é”äº¤æ˜“å·²å‘é€: ${txHash}ï¼ˆå¯åœ¨BscScanæŸ¥è¯¢ï¼‰`; 
                    statusEl.className = 'status success'; 
                }

                // ç­‰å¾…äº¤æ˜“ç¡®è®¤åæ¸…ç©ºè¾“å…¥æ¡†
                setTimeout(() => {
                    if (unstakeIndexInput) unstakeIndexInput.value = '';
                }, 8000);
            } catch (error) {
                console.error('è§£é”å¤±è´¥:', error);
                let errorMsg = error.message;
                if (errorMsg.includes('no transaction hash')) {
                    errorMsg = 'äº¤æ˜“æ— å“ˆå¸Œï¼šå¯èƒ½æ˜¯ç´¢å¼•æ— æ•ˆã€æœªåˆ°è§£é”æ—¶é—´æˆ–gasä¸è¶³';
                }
                if (statusEl) { statusEl.textContent = `è§£é”å¤±è´¥: ${errorMsg}`; statusEl.className = 'status error'; }
            }
        }

        // ==================== UIæ›´æ–°å‡½æ•° ====================
        function updateAccountDisplay() {
            if (domElements.connectedAccountEl && currentAccount) {
                domElements.connectedAccountEl.textContent = `${currentAccount.substring(0,6)}...${currentAccount.substring(38)}`;
            }
        }

        function updateNetworkDisplay() {
            if (domElements.currentNetworkEl && currentChainId) {
                const networkName = currentChainId === BSC_MAINNET_CHAIN_ID ? 'BSCä¸»ç½‘ï¼ˆ56ï¼‰' : `æœªçŸ¥ç½‘ç»œï¼ˆ${currentChainId}ï¼‰`;
                domElements.currentNetworkEl.textContent = networkName;
            }
        }
    </script>
</body>
</html>
